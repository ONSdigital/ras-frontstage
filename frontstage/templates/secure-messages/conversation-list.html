{% extends 'layouts/_base.html' %}

{% set page_title = "Messages" %}

{% block content %}
{% include "partials/tab_list.html" %}

<div role="main" id="main" class="page__main">
    {% with messages = get_flashed_messages() %}
      {% if messages %}
      <div class="panel panel--simple panel--success col-6@m">
          <div class="panel__body" data-qa="success-body">
            {% for message in messages %}
            <p class="u-fs-r" id="flashed-message-{{ loop.index }}">{{ message }}</p>
            {% endfor %}
          </div>
      </div>
      <br>
      {% endif %}
    {% endwith %}

    <section class="u-mb-s">
      {% from "components/section-navigation/_macro.njk" import onsSectionNavigation %}
      {{
          onsSectionNavigation({
              "ariaLabel": "Section menu",
              "ariraListLabel": "Navigation menu",
              "tabQuery": "closed" if is_closed else "open",
              "itemsList": [
                  {
                      "title": "Open",
                      "url": url_for('secure_message_bp.view_conversation_list')
                  },
                  {
                      "title": "Closed",
                      "url": url_for('secure_message_bp.view_conversation_list', is_closed='true')
                  }
              ]
          })
      }}    
    </section>
    {% if not messages %}
      {% if is_closed %}
      <p>No closed conversations</p>
      {% else %}
      <p>No new conversations</p>
      {% endif %}
    {% else %}

      <ul class="message-list">
        {% for message in messages %}
          {% if message['unread'] %}
            <li id="message-list-unread" class="message-list__item u-fs-r--b">
              <a href="{{ url_for('secure_message_bp.view_conversation', thread_id=message.thread_id) }}#latest-message" id="message-link-{{ loop.index }}">{{ message.subject }}</a>
              <span class="secure-message-conversation-meta__label u-fs-s--b" style="color: #666;"> (New) </span>
          {% else %}
            <li id="message-list" class="message-list__item u-fs-r">
            <a href="{{ url_for('secure_message_bp.view_conversation', thread_id=message.thread_id) }}#latest-message" class="message-read" id="message-link-{{ loop.index }}">{{ message.subject }}</a>
          {% endif %}

          <div class="message-details">
            <div class="secure-message-sent-message-meta-from u-fs-r">
              <span class="u-vh">From: </span>
              {{ message.from or 'Unavailable' }}
            </div>

            <div class="secure-message-sent-message-meta-datetime u-fs-r u-mb-s" style="display: block; color: #666;">
              <span class="u-vh">Sent: </span>
              {{ message.sent_date or 'Unavailable' }}
            </div>
          </div>

          <p class="message-list__item-preview u-fs-r" id="message-summary-{{ loop.index }}">{{ message['body']|truncate(80, False, '...', 0) }}</p>

          {% if message['unread'] %}
            <p class="message-list__item-preview--link">
              <a href="{{ url_for('secure_message_bp.view_conversation', thread_id=message.thread_id) }}#latest-message" class="u-fs-r--b" id="open-conversation-link-{{ loop.index }}">Read full message</a>
            </p>
          {% else %}
            <p class="message-list__item-preview--link">
              <a href="{{ url_for('secure_message_bp.view_conversation', thread_id=message.thread_id) }}#latest-message" class="message-read" id="open-conversation-link-{{ loop.index }}">Read full message</a>
            </p>
          {% endif %}

          </li>
        {% endfor %}
      </ul>
    {% endif %}
</div>
{% endblock content %}
