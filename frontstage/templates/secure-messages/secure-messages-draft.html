{% extends "secure-messages/messages.html" %}

{% set errors = errors %}

{% block page_title %}
Send secure message
{% endblock %}

{% block messages %}

    {% include 'secure-messages/message-error-summary.html' %}

    <div class="grid grid--reverse">
        <div class="grid__col col-4@m"></div>
        <div class="grid__col col-7@m pull-1@m">
            {% if errors|length == 0 %}
            <div class="system-feedback"> 
                <ul class="system-feedback__list"> 
                    <li class="system-feedback__list-item system-feedback__list-item--success"> 
                        <i class="fa fa-check-circle system-feedback__icon" aria-hidden="true" id="inbox-link"> </i>
                        Draft saved.
                        <a href="{{ url_for('secure_message_bp.messages_get') }}">View your inbox</a> 
                    </li> 
                </ul> 
            </div>
            {% endif %}

            {% if message %}
            <h1 class="saturn">Subject: {{ message['subject'] }}</h1>
            <div class="grid">
                <dl>
                    <dt class="grid__col col-2@s">From:</dt>
                    <dd class="grid__col col-10@s">
                    {% if message['@msg_from']['id'] == 'BRES' %}
                        {{ message['@msg_from']['id'] }}
                    {% else %}
                        {{ message['@msg_from']['email'] }}
                    {% endif %}
                    </dd>
                    <dt class="grid__col col-2@s">Sent:</dt>
                    <dd class="grid__col col-10@s">{{ message['sent_date'][:19] }}</dd>
                </dl>
            </div>
            <br />
            <p> {{ message['body'] }} </p>
            {% endif %}

            <h1 class="saturn">Edit a draft message</h1>
            <div class="secure-message-form">
                <form action="{{ url_for('secure_message_bp.create_message') }}" method="post">
                    <p>To: ONS Business Surveys team</p>

                    <input
                            id="msg_id"
                            type ="hidden"
                            name="msg_id"
                            value="{{draft['msg_id']}}">

                        {% if "subject" in errors %}
                        <div class="panel panel--simple panel--error panel--spacious">
                            <p class="error-message">{{ errors['subject'][0] }}</p>
                        {% endif %}

                        {% if draft['msg_id'] == draft['thread_id'] %}
                            <input name="secure-message-subject" type="hidden" id="secure-message-subject" value="{{ subject }}">
                        {% else %}
                            <fieldset>
                            <label for="secure-message-subject">Subject</label>
                            <input readonly
                                id="secure-message-subject"
                                class="secure-message-form__subject input input--text"
                                type="text"
                                name="secure-message-subject"
                                value="{{ draft['subject'] }}"/>
                        </fieldset>
                        {% endif %}

                        {% if "subject" in errors %}
                        </div>
                        {% endif %}

                        <br />

                        {% if "body" in errors %}
                        <div class="panel panel--simple panel--error panel--spacious">
                            <p class="error-message">{{ errors['body'][0] }}</p>
                        {% endif %}

                        <fieldset>
                            <label for="secure-message-body">Message</label>
                            <textarea
                                id="secure-message-body"
                                class="secure-message-form__body input"
                                rows="10"
                                name="secure-message-body">{{ draft['body'] }}</textarea>
                        </fieldset>

                        {% if "body" in errors %}
                        </div>
                        {% endif %}

                    <br />

                    <input class="btn btn--secondary" type="submit" name ="submit" value="Save draft" id="draft">
                    <input class="btn" type="submit" name='submit' value="Send" id="send-message">
                    <p><a href="{{ url_for('secure_message_bp.messages_get', label='DRAFT') }}">Cancel</a></p>
                </form>
            </div>
        </div>
    </div>

{% endblock messages %}
