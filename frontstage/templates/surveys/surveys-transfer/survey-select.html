{% extends "layouts/_block_content.html" %}
{% from "components/breadcrumbs/_macro.njk" import onsBreadcrumbs %}
{% from "components/fieldset/_macro.njk" import onsFieldset %}
{% from "components/checkboxes/_macro.njk" import onsCheckboxes %}
{% from "components/button/_macro.njk" import onsButton %}
{% from "components/list/_macro.njk" import onsList %}
{% from "components/details/_macro.njk" import onsDetails %}
{% set page_title = "Transfer your surveys" %}
{% set breadcrumbsData = [
    {
        "text": "Back",
        "url": "/surveys/todo",
        "id": "b-item-1"
    },
] %}

{% block breadcrumbs %}
    {{
        onsBreadcrumbs({
            "ariaLabel": "Breadcrumbs",
            "id": "breadcrumbs",
            "itemsList": breadcrumbsData
        })
    }}
{% endblock breadcrumbs %}

{% block main %}
    {% set ns = namespace (businesses = []) %}
    {% set selected_businesses_and_surveys = [] %}
    {% set failed_business_ids = [] %}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% if messages|length == 1 %}
                {% set errorTitle = "There is 1 error on this page" %}
            {% elif messages|length > 1 %}
                {% set errorTitle = "There are " ~ messages|length ~ " errors on this page" %}
            {% endif %}
            {% call
                onsPanel({
                    "variant": "error",
                    "classes": "ons-u-mb-s",
                    "title": errorTitle
                })
            %}
                {% set errorData = [] %}
                {% for business_id, message in messages %}
                    {% do ns.businesses.append(category) %}
                    {% do errorData.append(
                        {
                            "text": message,
                            "url": "#option_error_"~business_id,
                            "classes": "ons-js-inpagelink"
                        }
                    ) %}
                    {% do failed_business_ids.append(business_id) %}
                {% endfor %}
                {{
                    onsList({
                        "element": "ol",
                        "itemsList": errorData
                    })
                }}
            {% endcall %}
        {% endif %}
    {% endwith %}
    <h1 class="ons-u-mb-m">Transfer your surveys</h1>
    {% call onsPanel({
        "classes": "ons-u-mb-m",
        })
    %}
    <p >
        If you transfer a survey, you will no longer have access to it. If you will still need access to the survey, <a href="{{ url_for("account_bp.share_survey_overview") }}">share access to surveys</a>.
    </p>
    {% endcall %}
       {%
        call onsDetails({
            "classes": "ons-u-mb-xl",
            "id": "details-example-with-warning",
            "title": "How do I transfer a survey?"
        })
    %}
    <p>To transfer a survey:</p>
    {{
        onsList({
            "element": "ol",
            "itemsList": [
                {
                    "text": "Choose the surveys you want to transfer."
                },
                {
                    "text": "Enter the email address of the person who will be responding to the surveys."
                },
                {
                    "text": "We will email them instructions to access the surveys."
                },
                {
                    "text": "Once we confirm their access, they will be able to respond to the surveys and share access with their colleagues."
                }
            ]
        })
    }}
    {% endcall %}

    <form action='' method="post">
        <h2 class="ons-u-mb-l">Choose the surveys you want to transfer</h2>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        {% set selected_surveys = [] %}
        {% set selected_businesses_and_surveys = [] %}
        {% for business in survey_selection %}
            {% set failed_surveys = [] %}
            {% set checkboxData = [] %}
            {% set selected_businesses_and_surveys = (
                {
                    "business_id": business["business_id"]
                }
            ) %}
            {% if get_flashed_messages(with_categories=true) | length %}
                {% if error == "surveys_not_selected" and business %}
                    {% set errorOption = { "text": "You need to select a survey",  "id": "option_error_"~business["business_id"] } %}
                {% endif %}
                {% if error == "max_transfer_survey_exceeded" and (business["business_id"] in failed_business_ids) %}
                    {% set errorOption = { "text": "Deselect the survey/s to continue or call 0300 1234 931 to discuss your options.",  "id": "option_error_"~business["business_id"] } %}
                {% endif %}
            {% endif %}
            {% set checkboxesData = {
                "legend": "Organisation: " + business.business_name,
                "legendClasses": "ons-u-mb-xs",
                "description": "RU ref: " + business.business_ref,
                "descriptionClasses": "ons-u-mb-l",
                "checkboxesLabel": "Select all that apply",
                "checkboxesLabelClasses": "ons-u-mt-m",
                "classes": "ons-u-mb-l",
                "error": errorOption,
                "id": business["id"],
            } %}
            {% for survey in business.surveys %}
                {% set business_and_survey = (
                    {
                        "business_id": business.business_id,
                        "survey_id": survey["id"],
                    })
                %}
                {% if survey["id"] in failed_surveys_list %}
                    {% set params = "input--error" %}
                {% else %}
                    {% set params = '' %}
                {% endif %}
                {% if survey["id"] in selected_survey_list %}
                    {% set checked = true %}
                {% else %}
                    {% set checked = false %}
                {% endif %}
                {% do checkboxData.append(
                    {
                        "id": survey["id"],
                        "name": "selected_surveys",
                        "label": {
                            "text": survey["longName"]
                        },
                        "value": business_and_survey,
                        "classes": params,
                        "checked": checked
                    }
                    ) %}
            {% endfor %}
            <input type="hidden" name="business_and_surveys" value={{ business.business_id }} />
            {% do checkboxesData | setAttribute("checkboxes", checkboxData) %}
            {{ onsCheckboxes(checkboxesData) }}
        {% endfor %}
        <div class="ons-field">
            {{
                onsButton({
                    "text": "Continue",
                    "submitType": "timer"
                })
            }}
        </div>
    </form>
{% endblock main %}
